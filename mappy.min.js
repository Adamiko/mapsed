/*
 * Developed by : www.toepoke.co.uk
 *
 * If you redistribute this file, please keep this section in place.
 *
 * License: Same as jQuery - see http://jquery.org/license
 *
*/

(function(){var R=1;$.fn.mappy=function(S){function T(){$(this).parents(".mappy-root");var a=$(this).parents(".mappy-view"),a=z(a);d.onSelect(l,a)&&u()}function U(){var a=$(this).parents(".mappy-root"),b=a.find(".mappy-lat").val(),a=a.find(".mappy-lng").val(),b=A(b,a);u();b.showTooltip(!0)}function V(){var a=$(this).parents(".mappy-root").find(".mappy-view"),a=z(a);d.onDelete(l,a)&&(a=A(a.lat,a.lng),a.setMap(null),a.tooltip=null)}function W(){var a=$(this).parents(".mappy-root").find(".mappy-edit"),
b="",c=z(a),b=d.onSave(l,c),a=a.find(".mappy-error");b&&0<b.length?a.text(b):(a.text(""),b=A(c.lat,c.lng),jQuery.extend(b.details,c),b.markerType="custom",b.showTooltip(!1))}function B(a){D||E();D=!1;for(var b=new e.LatLngBounds,c=0,g;g=a[c];c++)g.reference&&v.getDetails({reference:g.reference},function(a,c){if(c==w.PlacesServiceStatus.OK){var g=F(a,a.geometry.location,"google",b).details,d=a.address_components,e=r(d,"street_address");""===e&&(e=r(d,"route"));var f=r(d,"locality"),k=r(d,"administrative_area_level_1"),
d=r(d,"postal_code");g.street=e;g.town=f;g.area=k;g.postCode=d;g.name=a.name||"";a.photos&&0<a.photos.length&&(g.photo=a.photos[0]);g.url=a.url||"";g.website=a.website||"";g.telNo=a.formatted_phone_number||a.telNo||"";h.fitBounds(b)}})}function X(){var a=h.getBounds();a&&x.setBounds(a);C=!0}function F(a,b,c,g){c=G(a.name,b,!1,c);jQuery.extend(c.details,a);H(c);k.push(c);g.extend(b);e.event.addListener(c,"click",function(){u();this.showTooltip(!1)});a.autoShow&&c.showTooltip(!1);C=!0;return c}function I(a,
b,c){a=m("{NAME}",b.name,a);var g=b.name,d=25,q=g;d||(d=30);g.length>d&&(q=g.substring(0,d-3)+"...");a=m("{SHORT_NAME}",q,a);a=m("{STREET}",b.street,a);a=m("{TOWN}",b.town,a);a=m("{AREA}",b.area,a);a=m("{POSTCODE}",b.postCode,a);a=m("{TELNO}",b.telNo,a);a=m("{WEBSITE}",b.website,a);a=m("{GPLUS}",b.url,a);b.photo&&(b=b.photo.getUrl({maxWidth:"70"}),a=m("{PHOTOURL}",b,a),a=m("{IMG","<img",a));c.html(a)}function A(a,b){for(var c=null,g=0;g<k.length;g++){var d=k[g];if(d.position.lat()==a&&d.position.lng()==
b){c=d;break}}return c}function Y(){var a="mappy-search-box-"+J;p=$("#"+a);if(!(0<p.length)){var b=d.searchOptions,a="<input type='text' id='"+a+"' class='mappy-searchbox' autocomplete='off' placeholder='",a=b.enabled&&b.placeholder?a+b.placeholder:a+"Search ...",a=a+"' ";b.enabled&&b.initSearch&&0<b.initSearch.length&&(a+=" value='"+b.initSearch+"'");a+=" />";p=$(a).appendTo(f);x=new w.SearchBox(p[0]);h.controls[e.ControlPosition.TOP_LEFT].push(p[0]);e.event.addListener(x,"places_changed",function(){var a=
x.getPlaces();B(a)});e.event.addListener(h,"bounds_changed",X);y("Go",e.ControlPosition.TOP_LEFT,"mappy-search-button",function(a){a.preventDefault();a=p.val();v.textSearch({query:a},B)})}}function Z(){K||(K=y("+|Add a place",e.ControlPosition.TOP_RIGHT,"mappy-add-button",function(a){a.preventDefault();a=h.getCenter();var b=new e.LatLngBounds,c=G("New place",a,!0,"new");H(c);k.push(c);b.extend(a);e.event.addListener(c,"click",function(){u();this.showTooltip(!0)});e.event.addListener(c,"dragend",function(a){this.details.lat=
a.latLng.lat();this.details.lng=a.latLng.lng();a=$(this.tooltip.content);a.find(".mappy-lat").val(this.details.lat);a.find(".mappy-lng").val(this.details.lng)});e.event.trigger(c,"click")}))}function aa(){if(!L){var a=function(a){a.preventDefault();s&&(a=!0,d.onClose&&(a=d.onClose(l)),a&&s&&l.closeMap())};L=y("X|Close map",e.ControlPosition.TOP_RIGHT,"mappy-close-button",a);$("body").on("keyup",function(b){b.preventDefault();27==b.which&&a(b)})}}function ba(){if(!n){t=y("?|Show help",e.ControlPosition.TOP_RIGHT,
"mappy-help-button",function(a){a.preventDefault();n.fadeToggle();t.toggleClass("open")});var a=d.getHelpWindow();n=$(a).appendTo(f);n.fadeOut()}}function y(a,b,c,g){var d=null,q=d="";c&&0<c.length&&(d=" class='"+c+"' ");a&&0<a.length&&(c=a.split("|"),a=c[0],q=1<c.length?" title='"+c[1]+"'":"");d=l.addMapControl("<a href='#'"+d+q+">"+a+"</a>",b);if(g)d.on("click",g);return d}function E(){if(k&&0<k.length)for(var a=0;a<k.length;a++){var b=k[a];b.tooltip=null;b.setMap(null)}k=[]}function u(){if(k&&
0<k.length)for(var a=0;a<k.length;a++){var b=k[a];b.tooltip&&b.tooltip.close()}}function G(a,b,c,g){var f=null;d.getMarkerImage&&(f=d.getMarkerImage(l,g));a=new e.Marker({map:h,icon:f,title:a,animation:e.Animation.DROP,position:b,markerType:g,draggable:c});a.details={markerType:g,lat:b.lat(),lng:b.lng(),reference:"",name:"",street:"",town:"",area:"",postCode:"",telNo:"",website:"",url:"",canEdit:"new"==g||"custom"==g};return a}function H(a){if(a.id){var b=$("#mappy-"+a.id);return b}var b=k.length+
1,c=a.details;a.id=b;b=$("<div id='mappy-"+b+"' class='mappy-root'><input type='hidden' class='mappy-lat' value='"+a.position.lat()+"' /><input type='hidden' class='mappy-lng' value='"+a.position.lng()+"' /><input type='hidden' class='mappy-can-edit' value='"+c.canEdit+"' /><input type='hidden' class='mappy-reference' value='"+c.reference+"' /><input type='hidden' class='mappy-marker-type' value='"+a.markerType+"' />"+M()+N()+"</div>");a.tooltip=new e.InfoWindow;a.tooltip.setContent(b[0]);a.tooltip.marker=
a;a.showTooltip=function(a){var b=this.tooltip,c=this.details,d=$(b.getContent()),e=d.find(".mappy-view"),d=d.find(".mappy-edit");l.getSettings();d.toggle(a);e.toggle(!a);O(c);if(a)a=N(),I(a,c,d);else{a=M();I(a,c,e);e.find(".mappy-name").parent().toggle(c.name&&0<c.name.length);e.find(".mappy-street").toggle(c.street&&0<c.street.length);e.find(".mappy-town").toggle(c.town&&0<c.town.length);e.find(".mappy-area").toggle(c.area&&0<c.area.length);e.find(".mappy-postCode").toggle(c.postCode&&0<c.postCode.length);
a=e.find(".mappy-telNo");var d=e.find(".mappy-website"),f=e.find(".mappy-url");c.telNo&&0<c.telNo.length?a.show().css("display","block"):a.hide();c.website&&0<c.website.length?d.show().css("display","block"):d.hide();c.url&&0<c.url.length?f.show().css("display","block"):f.hide();e.find(".mappy-right").toggle(null!=c.photo);f=l.getSettings();f.onSelect||f.onSave||f.onDelete?(a=null!=f.onSelect,d=null!=f.onSave&&c.canEdit,c=null!=f.onDelete&&c.canEdit&&"custom"==c.markerType,e.find(".mappy-select-button").toggle(a),
e.find(".mappy-edit-button").toggle(d),e.find(".mappy-delete-button").toggle(c)):e.find(".mappy-buttons").hide()}b.close();b.open(h,this)};return b}function M(){return"<table class='mappy-container mappy-view'><tr><td colspan='2'><h1 class='mappy-name' title='{NAME}'>{SHORT_NAME}</h1></td></tr><tr><td class='mappy-left'><address><div class='mappy-street'>{STREET}</div><div class='mappy-town'>{TOWN}</div><div class='mappy-area'>{AREA}</div><div class='mappy-postCode'>{POSTCODE}</div></address><a class='mappy-telNo' href='{TELNO}'>{TELNO}</a><a class='mappy-website' href='{WEBSITE}' title='{WEBSITE}'>website</a><a class='mappy-url' href='{GPLUS}' title='{GPLUS}'>g+</a></td><td class='mappy-right'><a href='{GPLUS}'>{IMG src='{PHOTOURL}' /></a></td></tr><tr class='mappy-buttons'><td colspan='2'><button class='mappy-select-button'>Select</button><button class='mappy-edit-button'>Edit</button><button class='mappy-delete-button'>Delete</button></td></tr></table>"}
function N(){return"<div class='mappy-container mappy-address-entry mappy-edit'><h1>Place details:</h1><ul><li><label>Name<input class='mappy-name' type='text' placeholder='e.g. Bob sandwich shop' value='{NAME}' /></label></li><li><label>Street<input class='mappy-street' type='text' placeholder='e.g. 3 Hemington place' value='{STREET}' /></label></li><li><label>Town<input class='mappy-town' type='text' placeholder='e.g. Leeds' value='{TOWN}' /></label></li><li><label>Area<input class='mappy-area' type='text' placeholder='e.g. West Yorkshire' value='{AREA}' /></label></li><li><label>Postcode<input class='mappy-postCode' type='text' value='{POSTCODE}' /></label></li><li><label>Tel No<input class='mappy-telNo' type='telephone' placeholder='contact telephone number' value='{TELNO}' /></label></li><li><label>website<input class='mappy-website' type='url' placeholder='e.g. https://toepoke.co.uk' value='{WEBSITE}' /></label></li><li><label>g+ url<input class='mappy-url' type='url' placeholder='e.g. https://plus.google.com/+ToepokeCoUk\u200e' value='{GPLUS}' /></label></li></ul><div class='mappy-buttons'><button class='mappy-save-button'>Save</button><span class='mappy-error'>&nbsp;</span></div></div>"}
function z(a){var b=a.parents(".mappy-root"),b={canEdit:"true"===b.find(".mappy-can-edit").val(),lat:b.find(".mappy-lat").val(),lng:b.find(".mappy-lng").val(),reference:b.find(".mappy-reference").val(),markerType:b.find(".mappy-marker-type").val()};a.hasClass("mappy-view")?(b.name=a.find(".mappy-name").attr("title"),b.street=a.find(".mappy-street").html(),b.town=a.find(".mappy-town").html(),b.area=a.find(".mappy-area").html(),b.postCode=a.find(".mappy-postCode").html(),b.telNo=a.find(".mappy-telNo").html(),
b.website=a.find(".mappy-website").attr("href"),b.url=a.find(".mappy-url").attr("href")):(b.name=a.find(".mappy-name").val(),b.street=a.find(".mappy-street").val(),b.town=a.find(".mappy-town").val(),b.area=a.find(".mappy-area").val(),b.postCode=a.find(".mappy-postCode").val(),b.telNo=a.find(".mappy-telNo").val(),b.website=a.find(".mappy-website").val(),b.url=a.find(".mappy-url").val());O(b);return b}function O(a){a.canEdit||(a.canEdit=!1);a.lat||(a.lat=0);a.lng||(a.lng=0);a.name||(a.name="");a.street||
(a.street="");a.town||(a.town="");a.area||(a.area="");a.postCode||(a.postCode="");a.telNo||(a.telNo="");a.website||(a.website="");a.url||(a.url="")}function ca(){var a=new e.LatLngBounds;E();for(var b=0;b<d.customPlaces.length;b++){var c=d.customPlaces[b],g=new e.LatLng(c.lat,c.lng);F(c,g,"custom",a)}h.fitBounds(a)}function r(a,b,c){if(null==a||0==a.length)return"";for(var d="",e=0;e<a.length;e++){for(var f=a[e],h=!1,k=0;k<f.types.length;k++)if(f.types[k].toLowerCase()==b.toLowerCase()){h=!0;break}if(h){d=
c?f.short_name:f.long_name;break}}return d}var da=new google.maps.LatLng(53.798823,-1.5426760000000286),l=this,p=null,x=null,h=null,f=null,v=null,k=[],J=-1,s=!1,D=!0,P=!1,C=!1,t=null,n=null,L=null,K=null,e=null,w=null,d=$.extend({customPlaces:null,mapOptions:{zoom:10,center:da,mapTypeId:google.maps.MapTypeId.ROADMAP},disablePoi:!1,allowAdd:!1,searchOptions:{enabled:!1,placeholder:"e.g. Hotels in Leeds",initSearch:"Hotels in Leeds"},onSelect:null,onSave:null,onDelete:null,onClose:null,getHelpWindow:null,
showHelpOnLoad:!1},S||{});this.getSettings=function(){return d};this.getGoogleMap=function(){return h};this.getMapContainer=function(){return f};this.addMapControl=function(a,b){var c=null,c=null,c=$(a);c.hasClass("mappy-control-button")||c.addClass("mappy-control-button");c=c.appendTo(f);h.controls[b].push(c[0]);return c};this.disablePointsOfInterest=function(){h.styles=[{featureType:"poi",stylers:[{visibility:"off"}]}]};this.closeMap=function(){h=null;n&&n.fadeOut();f.fadeOut(function(){$(this).remove()});
s=!1};var m=function(a,b,c){void 0==b&&(b="");return c.replace(RegExp(a,"g"),b)},Q=function(){var a=null;e=google.maps;w=google.maps.places;a=f.attr("id");h=new e.Map(document.getElementById(a),d.mapOptions);d.disablePoi&&l.disablePointsOfInterest();v=new w.PlacesService(h);J=R++;if(d.onSelect)f.on("click","button.mappy-select-button",T);d.onSave&&(f.on("click","button.mappy-save-button",W),f.on("click","button.mappy-edit-button",U));if(d.onDelete)f.on("click","button.mappy-delete-button",V);d.searchOptions.enabled&&
Y();(s||d.onClose)&&aa();null!=d.customPlaces&&ca();d.getHelpWindow&&ba();d.allowAdd&&Z();if(d.onPreInit)d.onPreInit(l);e.event.addListener(h,"tilesloaded",function(a){if(!P){if(n){a=t;a.position();a.width();n.width();var c=a.position().top,c=c+2*a.height();n.css("z-index",999).css("position","absolute").css("top",c).css("right","1%").css("width","20%");d.showHelpOnLoad&&t.click&&t.trigger("click")}P=!0;if(d.onInit)d.onInit(l)}});a=d.searchOptions;a.enabled&&a.initSearch&&0<a.initSearch.length&&v.textSearch({query:a.initSearch},
B);C||(h.setZoom(d.mapOptions.zoom),h.setCenter(d.mapOptions.center))};this.each(function(){f=$(this);Q()});this.length||(f=$("#mappy-full-window"),f.length||(f=$("<div id='mappy-full-window' class='mappy-full-window'></div>"),f.appendTo("body")),s=!0,Q());return this}})(jQuery);
